# admin-users（管理：ユーザー管理画面） E2Eテスト仕様書

生成日: 2026-01-31
対象ページ: `/admin/users`
権限レベル: admin（管理者のみ）

---

## テスト環境

```yaml
URL: http://localhost:5173/admin/users
認証: 必須（ProtectedRoute + 管理者権限）
テストアカウント:
  email: fulltest@example.com
  password: FullTest123!
  権限: 管理者（is_admin=true）
```

---

## 統合テストでカバー済み（E2Eから除外）

このプロジェクトには統合テストが存在しないため、以下の項目は**E2Eテストでもカバーしない**:
- ❌ 認証エラー（401）: バックエンドロジックテスト
- ❌ 権限エラー（403）: バックエンドロジックテスト
- ❌ バリデーションエラー（400）: バックエンドロジックテスト
- ❌ API通信エラー: バックエンドロジックテスト

**E2Eの目的**: UIを通じたユーザー操作フローのみを検証する

---

## E2Eテスト項目一覧（UIフローのみ: 7項目）

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUSERS-001 | ページアクセス・一覧表示 | 管理者でログイン → /admin/users → ページタイトル「ユーザー管理」、テーブル表示、ページネーション表示 |
| E2E-AUSERS-002 | ユーザー情報表示確認 | テーブルに名前、メールアドレス、ステータス（アクティブ）、プラン（無料）、登録日、最終ログイン、操作メニューが表示される |
| E2E-AUSERS-003 | フィルタリングフロー | ステータスフィルター選択 → プランフィルター選択 → 検索フィールド入力 → 結果が絞り込まれる → ページが1ページ目にリセットされる |
| E2E-AUSERS-004 | 検索機能フロー | 検索フィールドに名前またはメールアドレスを入力 → 結果がフィルタリングされる → クリア → すべてのユーザーが表示される |
| E2E-AUSERS-005 | ページネーションフロー | 「次へ」ボタンクリック → 次ページ表示 → 「前へ」ボタンクリック → 前ページ表示 → 表示件数変更（5/10/25/50件）→ ページ情報が正しく表示される（「1-10 / 25件」形式） |
| E2E-AUSERS-006 | ユーザー操作メニュー表示 | 操作メニューボタン（三点リーダー）クリック → メニューが開く → テーブルが横に伸びない → 「停止する」メニューが表示される → メニューをクリック → メニューが閉じる |
| E2E-AUSERS-007 | 更新ボタンフロー | 「更新」ボタンクリック → ローディング状態表示 → ユーザー一覧が再取得される → 最新データが表示される |

---

## 各テスト項目の詳細

### E2E-AUSERS-001: ページアクセス・一覧表示

**目的**: 管理者がユーザー管理画面にアクセスし、基本UIが正しく表示されることを確認する

**前提条件**:
- 管理者アカウント（fulltest@example.com）でログイン済み
- 最低1件以上のユーザーがデータベースに存在する

**操作フロー**:
1. `/admin/users` にアクセス
2. ページが読み込まれるまで待機

**期待結果**:
- ページタイトル「ユーザー管理」が表示される
- 「更新」ボタンが右上に表示される
- 簡易版の説明アラートが表示される
- フィルタセクションが表示される（ステータスフィルタ、プランフィルタ、検索フィールド）
- ユーザーテーブルが表示される
- テーブルヘッダーに「名前」「メールアドレス」「ステータス」「プラン」「登録日」「最終ログイン」「操作」が表示される
- ページネーションが表示される

---

### E2E-AUSERS-002: ユーザー情報表示確認

**目的**: ユーザー一覧に正しい情報が表示されることを確認する

**前提条件**:
- E2E-AUSERS-001が完了している

**操作フロー**:
1. ユーザーテーブルの1行目を確認

**期待結果**:
- 名前が表示される（メールアドレスから生成された名前、または "-"）
- メールアドレスが表示される
- ステータスが「アクティブ」として表示される（簡易版の仕様）
- プランが「無料」として表示される（簡易版の仕様）
- 登録日が「YYYY/MM/DD HH:MM」形式で表示される（または "-"）
- 最終ログイン日が「YYYY/MM/DD HH:MM」形式で表示される（または "-"）
- 操作メニューボタン（三点リーダー）が表示される

---

### E2E-AUSERS-003: フィルタリングフロー

**目的**: ステータス、プラン、検索の複合フィルタリングが正しく動作することを確認する

**前提条件**:
- E2E-AUSERS-001が完了している
- 複数のユーザーが存在する

**操作フロー**:
1. ステータスフィルターで「アクティブ」を選択
2. プランフィルターで「無料」を選択
3. 検索フィールドに任意のテキストを入力
4. 結果を確認

**期待結果**:
- 各フィルター適用時にユーザー一覧が更新される
- フィルタ条件に一致するユーザーのみが表示される
- フィルタ変更後、ページが1ページ目にリセットされる
- 複数のフィルターを組み合わせて使用できる

---

### E2E-AUSERS-004: 検索機能フロー

**目的**: 名前・メールアドレスでの検索が正しく動作することを確認する

**前提条件**:
- E2E-AUSERS-001が完了している
- 検索可能なユーザーが存在する（例: fulltest@example.com）

**操作フロー**:
1. 検索フィールドに「fulltest」と入力
2. 結果を確認
3. 検索フィールドをクリア
4. 結果を確認

**期待結果**:
- 検索入力後、名前またはメールアドレスに「fulltest」を含むユーザーのみが表示される
- 検索クリア後、すべてのユーザーが表示される
- 検索は大文字・小文字を区別しない

---

### E2E-AUSERS-005: ページネーションフロー

**目的**: ページネーションが正しく動作することを確認する

**前提条件**:
- E2E-AUSERS-001が完了している
- 10件以上のユーザーが存在する（ページネーションが発生する）

**操作フロー**:
1. 「次へ」ボタンをクリック
2. 2ページ目の表示を確認
3. 「前へ」ボタンをクリック
4. 1ページ目の表示を確認
5. 表示件数セレクトで「5件」を選択
6. ページ情報を確認

**期待結果**:
- 「次へ」ボタンクリック後、2ページ目が表示される
- 「前へ」ボタンクリック後、1ページ目が表示される
- 表示件数変更後、選択した件数のユーザーが表示される
- ページ情報が「1-10 / 25件」形式で正しく表示される
- 最初のページでは「前へ」ボタンが無効化される
- 最後のページでは「次へ」ボタンが無効化される

---

### E2E-AUSERS-006: ユーザー操作メニュー表示

**目的**: ユーザー操作メニューが正しく開閉し、テーブルレイアウトが崩れないことを確認する

**前提条件**:
- E2E-AUSERS-001が完了している

**操作フロー**:
1. 任意のユーザーの操作メニューボタン（三点リーダー）をクリック
2. メニューが開くことを確認
3. テーブルレイアウトを確認
4. メニュー内の「停止する」をクリック
5. メニューが閉じることを確認

**期待結果**:
- 操作メニューボタンクリック後、メニューが開く
- メニューが開いてもテーブルが横に伸びない
- メニューに「停止する」メニュー項目が表示される
- メニュー項目クリック後、メニューが閉じる
- エラーメッセージが表示されない

**注意**: Phase 11簡易版では、実際のステータス変更は行われません（UIテスト用のプレースホルダー実装）

---

### E2E-AUSERS-007: 更新ボタンフロー

**目的**: 「更新」ボタンでユーザー一覧が再取得されることを確認する

**前提条件**:
- E2E-AUSERS-001が完了している

**操作フロー**:
1. 「更新」ボタンをクリック
2. ローディング状態を確認
3. ユーザー一覧が再表示されることを確認

**期待結果**:
- 「更新」ボタンクリック後、ローディング状態が表示される
- ユーザー一覧が再取得される
- 最新のデータが表示される
- フィルタ・検索条件が維持される

---

## 実行コマンド

```bash
# 個別テスト実行（test.only()使用）
npx playwright test tests/e2e/admin-users.spec.ts

# すべてのテストを実行
npx playwright test tests/e2e/admin-users.spec.ts --headed

# デバッグモード
npx playwright test tests/e2e/admin-users.spec.ts --debug
```

---

## テスト実装時の注意事項

### 簡易版の仕様（Phase 11）

このページは**Phase 11簡易版**として実装されており、以下の制限があります:

1. **ステータス管理**: すべてのユーザーは常に「アクティブ」として表示されます
   - Userモデルに`status`フィールドが存在しないため
   - ステータス変更APIは成功レスポンスを返しますが、実際の更新は行われません

2. **プラン管理**: すべてのユーザーは「無料」プランとして表示されます
   - Stripe統合が未実装のため

3. **目的**: これらはUIテスト用のプレースホルダー実装です

### Playwrightセレクタ推奨

```typescript
// ページタイトル
page.getByRole('heading', { name: 'ユーザー管理' })

// 更新ボタン
page.getByRole('button', { name: '更新' })

// 検索フィールド
page.getByPlaceholder('名前またはメールアドレスで検索')

// ステータスフィルター
page.getByRole('button', { name: 'ステータス' })

// プランフィルター
page.getByRole('button', { name: 'プラン' })

// テーブルヘッダー
page.getByRole('columnheader', { name: '名前' })
page.getByRole('columnheader', { name: 'メールアドレス' })

// 操作メニューボタン
page.getByRole('button', { name: 'メニューを開く' }).first()

// ページネーション
page.getByRole('button', { name: '次へ' })
page.getByRole('button', { name: '前へ' })
```

### 待機戦略

```typescript
// API応答待機
await page.waitForResponse(response =>
  response.url().includes('/api/v1/admin/users/details') &&
  response.status() === 200
)

// テーブル行の存在確認
await page.locator('table tbody tr').first().waitFor()

// ローディング完了待機
await page.locator('text=読み込み中').waitFor({ state: 'hidden' })
```

---

## 品質チェックリスト

| 確認項目 | チェック |
|---------|---------|
| E2E項目数が5-10項目以内か？ | ✅ 7項目 |
| 統合テストカバレッジを確認したか？ | ✅ 統合テストなし |
| 認証エラー（401）を除外したか？ | ✅ 除外済み |
| バリデーションエラーを除外したか？ | ✅ 除外済み |
| レスポンシブテストを除外したか？ | ✅ 除外済み |
| 個別UI要素テストを除外したか？ | ✅ 除外済み |
| フロー単位で設計したか？ | ✅ フロー単位 |

---

**生成日**: 2026-01-31
**対象手動テスト**: docs/MANUAL_TEST_PHASE11_ADMIN.md（セクション7）
**E2E項目数**: 7項目（5-10項目厳守）
**実装推定時間**: 約20分
