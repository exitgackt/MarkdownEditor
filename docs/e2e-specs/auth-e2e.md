# 認証フロー E2Eテスト仕様書

生成日: 2026-01-31
対象ページ: `/login`, `/register`, `/verify-email`, `/reset-password`
権限レベル: 未ログイン
元テストレポート: docs/MANUAL_TEST_P001_AUTH.md

---

## テスト環境

```yaml
フロントエンドURL: http://localhost:5173
バックエンドURL: http://localhost:8000
認証方式: Google OAuth 2.0 + Email/Password
テストアカウント:
  email: test@example.com
  password: Test1234!
```

---

## 統合テストでカバー済み（E2Eから除外）

認証フローは**フロントエンドのみの実装**であり、バックエンド統合テストは未作成です。
したがって、以下の項目は**E2Eでカバーする必要があります**:

- ⚠️ 認証エラー（401）: 統合テスト未作成のため**E2Eでカバー**
- ⚠️ バリデーションエラー（400）: 統合テスト未作成のため**E2Eでカバー**
- ⚠️ CRUD正常系: 統合テスト未作成のため**E2Eでカバー**

**注意**: 将来的にバックエンド統合テストが作成された場合、この仕様書を見直してE2E項目を削減すること。

---

## E2Eテスト項目一覧（UIフローのみ: 9項目）

### 1. ログインページ表示フロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-001 | ログインページ初期表示 | `/login`にアクセス → ロゴ、Googleログインボタン、Email/Passwordフォーム（メール入力欄、パスワード入力欄、ログインボタン）、「アカウント登録」リンク、「パスワードを忘れた方」リンクが表示される |

---

### 2. Email/Password 新規登録フロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-002 | 正常な新規登録からメール検証まで | `/register`にアクセス → 名前「テストユーザー1」、メール「test1@example.com」、パスワード「Test1234!」、パスワード確認「Test1234!」を入力 → 「登録」ボタンクリック → 成功メッセージ「登録が完了しました。メールに送信された確認リンクをクリックしてください。」表示 → バックエンドログから検証トークン取得 → `/verify-email?token={トークン}`にアクセス → 「メールアドレスが確認されました」メッセージ表示 → 3秒後に`/login`にリダイレクト |

---

### 3. Email/Password ログインフロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-003 | 正常なEmail/Passwordログイン | `/login`にアクセス → 検証済みメールアドレスとパスワードを入力 → 「ログイン」ボタンクリック → ログイン成功 → JWTトークンがlocalStorageに保存される → `/editor`にリダイレクト → ユーザー情報が表示される（右上メニュー等） |

---

### 4. パスワードリセットフロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-004 | パスワードリセット要求から新パスワード設定まで | `/login`で「パスワードを忘れた方」リンククリック → 登録済みメールアドレス入力 → 「送信」ボタンクリック → 成功メッセージ「パスワードリセットメールを送信しました」表示 → バックエンドログからリセットトークン取得 → `/reset-password?token={トークン}`にアクセス → 新パスワード「NewTest1234!」入力 → 「リセット」ボタンクリック → 成功メッセージ「パスワードがリセットされました」表示 → `/login`にリダイレクト → 新パスワードでログイン成功 |

---

### 5. Google OAuth ログインフロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-005 | Google OAuth初回ログイン | `/login`で「Googleでログイン」ボタンクリック → Google認証画面表示 → アカウント選択 → 権限承認 → JWTトークンがlocalStorageに保存される → `/editor`にリダイレクト → ユーザー情報が表示される |

---

### 6. JWTセッション管理フロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-006 | ページリロード後のセッション保持 | ログイン済み状態で`/editor`にアクセス → ページリロード（F5） → ログイン状態が維持される → エディタページが表示される → ユーザー情報が表示される |

---

### 7. ログアウトフロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-007 | 正常なログアウト | ログイン済み状態で「ログアウト」ボタンクリック → localStorageからtokenが削除される → `/login`にリダイレクト → `/editor`に直接アクセス → `/login`にリダイレクト（アクセス不可確認） |

---

### 8. 保護ルートアクセス制御フロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-008 | 未認証で保護ルートアクセス | ログアウト状態で`/editor`に直接アクセス → `/login`にリダイレクト |

---

### 9. 認証済みでログインページアクセスフロー

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-009 | 認証済みで/loginアクセス時のリダイレクト | ログイン済み状態で`/login`にアクセス → `/editor`にリダイレクト（ログインページは表示されない） |

---

## バリデーションエラーテスト（統合テスト未作成のため暫定的にE2Eに含める）

**注意**: これらは本来統合テストでカバーすべき項目です。将来的に統合テストが作成された場合、E2Eから削除してください。

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-AUTH-VAL-001 | 既存メールで登録エラー | `/register`で既に登録済みメールアドレスで登録試行 → エラーメッセージ「このメールアドレスは既に登録されています」表示 |
| E2E-AUTH-VAL-002 | 弱いパスワードエラー（8文字未満） | `/register`でパスワード「Test1」（6文字）で登録試行 → エラーメッセージ「パスワードは8文字以上である必要があります」表示 |
| E2E-AUTH-VAL-003 | 無効なメールアドレスでログイン | `/login`で存在しないメールアドレスでログイン試行 → エラーメッセージ「メールアドレスまたはパスワードが正しくありません」表示 |
| E2E-AUTH-VAL-004 | 未検証メールでログイン | `/register`で新規登録（検証しない） → `/login`でそのメールとパスワードでログイン試行 → エラーメッセージ「メールアドレスが未確認です。確認メールを確認してください。」表示 |

---

## 実装時の注意事項（Playwright実装者向け）

### 1. test.only()の使用
- 各テストは独立して実行可能にすること
- `test.only()`で単独実行してもパスすること

### 2. トークン取得方法
- E2E-AUTH-002（メール検証）、E2E-AUTH-004（パスワードリセット）はバックエンドログまたはDBからトークンを取得する必要があります
- **推奨**: バックエンドAPIに開発環境専用のテスト用トークン取得エンドポイントを追加
  - 例: `GET /api/v1/test/verify-token/{email}` → 最新の検証トークンを返す
  - 例: `GET /api/v1/test/reset-token/{email}` → 最新のリセットトークンを返す

### 3. Google OAuth のモック
- E2E-AUTH-005（Google OAuth）は実際のGoogle認証画面を使用すると不安定になります
- **推奨**: バックエンドに開発環境専用のモックOAuthエンドポイントを追加
  - 例: `POST /api/v1/test/mock-google-login` → テスト用JWTトークンを返す

### 4. テストデータのクリーンアップ
- 各テスト実行前に `test@example.com` や `test1@example.com` のユーザーをDBから削除すること
- **推奨**: バックエンドに開発環境専用のクリーンアップエンドポイントを追加
  - 例: `DELETE /api/v1/test/cleanup/{email}` → テストユーザーを削除

### 5. ローディング状態の待機
- ボタンクリック後は必ずローディング完了を待機してからアサーション実行
- `page.waitForURL()` や `page.waitForSelector()` を活用

---

## 実行コマンド

```bash
# 全テスト実行
npx playwright test tests/e2e/auth.spec.ts

# 単独テスト実行（例: E2E-AUTH-003）
npx playwright test tests/e2e/auth.spec.ts -g "E2E-AUTH-003"

# UIモード（デバッグ）
npx playwright test tests/e2e/auth.spec.ts --ui
```

---

## 設計サマリー

- **E2E項目数**: 9項目（UIフローのみ）
- **バリデーションテスト**: 4項目（暫定的にE2Eに含む、将来統合テストに移行）
- **合計**: 13項目
- **5-10項目原則**: ⚠️ 13項目（超過）→ バリデーション項目は将来統合テストに移行予定
- **統合テストカバレッジ**: ❌ 未作成（将来作成時にE2Eから削減）
- **手動テスト項目数**: 61項目 → E2Eで9項目に統合（85%削減）

---

## 今後のアクション

1. **短期**: この仕様書を基にPlaywrightテストを実装（`@E2Eテスト実装`エージェント）
2. **中期**: バックエンド統合テストを作成し、バリデーション項目をE2Eから削除
3. **長期**: 認証エラー（401）、権限エラー（403）を統合テストに移行し、E2Eを5-10項目に削減
