# マークダウンエディタ - 要件定義ドラフト（確定）

> **ステータス**: Phase 14 完了 ✅
> **最終更新**: 2026-02-03
> **次のアクション**: 本番環境デプロイ準備・保守運用

---

## Step#1：成果定義（確定）

### a) 成果の詳細な定義
サブスクリプション型で提供するVisual Studio風マークダウンエディタ。**ブラウザサービス（Webアプリ）**として開発。ログイン認証・課金管理・管理者機能を備え、プレビュー・差分比較・ファイル管理・インポート/エクスポート・お気に入り機能を持つ商用アプリケーション。

### b) 成功を測る定量的指標
1. ファイルの読み込み・保存が3秒以内に完了する
2. リアルタイムプレビュー反映が500ms以内
3. 対応ファイルサイズ：最大1MB以上のマークダウンを扱える
4. 同時に開けるタブ数：10個以上
5. サービス稼働率：99%以上
6. エクスポート（PDF/HTML/Word）が10秒以内に完了する
7. Word⇔マークダウン変換が10秒以内に完了する
8. マインドマップ生成が1秒以内に完了する

### c) 成功を測る定性的指標
1. Visual Studioユーザーが違和感なく操作できる
2. ツリー表示でフォルダ構造が直感的に把握できる
3. 差分比較が視覚的にわかりやすい
4. 課金・契約状況が管理画面で把握できる
5. エクスポート出力がプレビュー表示と同等の品質
6. よく使うファイルにすぐアクセスできる
7. Word文書の変換精度が実用レベル
8. マインドマップで文書構造が一目で把握できる

---

## 主要機能一覧（確定）

| カテゴリ | 機能 | 詳細 |
|----------|------|------|
| 認証 | ログイン認証 | Googleログインのみ |
| 課金 | サブスクリプション | 後日追加（プラットフォーム検討中） |
| エディタ | フォルダ選択 | UI上で対象フォルダを指定 |
| エディタ | メニューバー | 画面上部、ファイル操作等 |
| エディタ | ファイルツリー | 左側パネル、全ファイル表示 |
| エディタ | タブ管理 | 複数ファイルをタブで切り替え |
| エディタ | マークダウン編集 | .mdファイルの編集 |
| エディタ | ファイル閲覧 | .md以外は閲覧のみ |
| プレビュー | リアルタイムプレビュー | 左右分割、同時プレビュー |
| プレビュー | 即時プレビュー | 手動でプレビュー実行 |
| インポート | マークダウン取込 | .mdファイルのインポート |
| インポート | テキスト取込 | .txtファイルのインポート |
| インポート | Word変換取込 | .docxをマークダウンに変換して取込 |
| エクスポート | PDF出力 | マークダウンをPDF形式で出力 |
| エクスポート | HTML出力 | マークダウンをHTML形式で出力 |
| エクスポート | Word出力 | マークダウンをWord文書(.docx)で出力 |
| マインドマップ | マインドマップ表示 | 見出し・リスト構造をマインドマップで可視化 |
| マインドマップ | ズーム/パン | マインドマップの拡大縮小・移動 |
| マインドマップ | 展開/折りたたみ | ノードの展開・折りたたみ操作 |
| マインドマップ | エクスポート | SVG/PNG形式で出力 |
| エディタ | 分割表示 | 複数ファイルを横並び |
| エディタ | 差分比較 | 2ファイル間の差異表示 |
| エディタ | 保存機能 | 上書き / 名前を付けて保存 |
| お気に入り | お気に入り登録 | ファイルをお気に入りに追加/解除 |
| お気に入り | お気に入り一覧 | ツリー状態に関係なく一覧表示・閲覧 |
| お気に入り | 存在チェック | ファイル不在時エラー表示＋解除確認 |
| 管理 | 利用状況確認 | 管理者用 |
| 管理 | システム設定 | 各種設定変更 |

---

## Step#2：実現可能性調査結果（確定）

### ✅ 実現可能な要素

| 機能 | 推奨技術 | 備考 |
|------|----------|------|
| マークダウンエディタ | Monaco Editor | VS Code同等、React対応、MIT License |
| リアルタイムプレビュー | react-markdown / markdown-it | 高速レンダリング |
| シンタックスハイライト | Monaco Editor内蔵 | 追加設定不要 |
| 差分比較 | Monaco Diff Editor | Monaco内蔵、VS Code同等の差分表示 |
| タブ管理 | React状態管理 | Zustand等で実装可能 |
| 分割表示 | react-resizable-panels | 柔軟なレイアウト |
| マークダウン→HTML | marked / markdown-it | MIT License |
| マークダウン→PDF | html2pdf.js / jsPDF | ブラウザ内でPDF生成 |
| 認証 | Google OAuth 2.0 | ブラウザでも対応可能 |
| ローカルファイル | File System Access API | Chrome/Edgeで直接アクセス可能 |
| マインドマップ | Markmap (markmap-lib + markmap-view) | MIT License、TypeScript対応、D3.js基盤 |

### ⚠️ 条件付きで実現可能

| 機能 | 条件・制限事項 |
|------|----------------|
| Word→マークダウン変換 | mammoth.js使用。複雑なレイアウトは変換精度に限界あり |
| マークダウン→Word変換 | Pandoc推奨（Electronにバンドル可能） |

---

## Step#2.5：開発アプローチ（確定）

| 項目 | 決定内容 |
|------|---------|
| アプローチ | 通常版（フル機能） |
| 課金機能 | 後から追加（Phase 11で拡張） |

---

## Step#3：認証・権限設計（確定）

| 項目 | 内容 |
|------|------|
| 認証方式 | Googleログインのみ |
| 登録方式 | 自由登録（Googleログインで即利用可能） |
| 管理者判定 | 登録済みメールアドレスで判定 |
| ユーザーロール | 一般ユーザー / 管理者 |

### 権限マトリックス

| 機能 | 未ログイン | 一般ユーザー | 管理者 |
|------|-----------|-------------|--------|
| ログイン画面 | ○ | × | × |
| 利用規約同意 | × | ○(初回) | ○(初回) |
| エディタ機能 | × | ○ | ○ |
| お気に入り機能 | × | ○ | ○ |
| 利用状況確認 | × | × | ○ |
| システム設定 | × | × | ○ |

---

## Step#4：ページリスト（確定）

| ID | ページ名 | 目的 | 権限 |
|----|---------|------|------|
| P-001 | ログイン | Googleログイン認証 | 未ログイン |
| P-002 | 利用規約同意 | 初回ログイン時に規約同意を求める | 初回ユーザー |
| P-003 | エディタ | マークダウン編集・プレビュー・ファイル操作 | ユーザー |
| P-004 | メンテナンス中 | メンテナンス時の案内表示 | 全員 |
| A-001 | 管理：利用状況 | ユーザー利用状況の確認 | 管理者 |
| A-002 | 管理：システム設定 | 各種設定の変更 | 管理者 |

### システム設定の詳細（A-002）

| 設定項目 | 説明 |
|----------|------|
| 対応ブラウザの案内文 | ログイン画面等に表示する案内 |
| サービス利用規約 | 利用規約の編集 |
| メンテナンスモード切替 | ON/OFFで切替 |
| 管理者の追加/削除 | メールアドレスで管理者を登録/解除 |

---

## Step#5：技術スタック（確定）

### ★アプリ形態：ブラウザサービス（Webアプリ）

| 項目 | 決定内容 |
|------|---------|
| アプリ形態 | **ブラウザサービス（Webアプリ）** |
| 対応ブラウザ | Chrome / Edge（優先）、Safari / Firefox（制限付き） |
| ファイルアクセス | File System Access API |
| 配布方法 | URLアクセス |

### フロントエンド（Webアプリ）
| 項目 | 技術 | 選定理由 |
|------|------|----------|
| ビルドツール | Vite | 高速、モダンなビルド環境 |
| UI | React 18 + TypeScript | 再利用可能なコンポーネント設計 |
| UIライブラリ | MUI v6 | VS Code風UIの実現 |
| エディタ | Monaco Editor | VS Code同等の編集・差分比較 |
| 状態管理 | Zustand | 軽量、タブ・ファイル管理に最適 |
| ファイル操作 | File System Access API | Chrome/Edgeでローカルファイルアクセス |
| PDF生成 | html2pdf.js / jsPDF | ブラウザ内でPDF生成 |
| マインドマップ | markmap-lib + markmap-view | マークダウン→マインドマップ変換・表示 |
| ホスティング | Vercel / Cloudflare Pages | 静的サイトホスティング |

### バックエンド（認証・課金・管理用）
| 項目 | 技術 | 選定理由 |
|------|------|----------|
| 言語 | Python | シンプル、高速開発 |
| フレームワーク | FastAPI | 型安全、自動ドキュメント |
| 認証 | Google OAuth 2.0 | Googleログイン |
| DB | PostgreSQL（Neon） | サーバーレス、無料枠 |
| ホスティング | Google Cloud Run | スケーラブル |

### 課金プラットフォーム（確定）

| 項目 | 決定内容 |
|------|---------|
| プラットフォーム | **Stripe** |
| 手数料 | 約3.6% |
| 理由 | Webアプリとの相性が良く、自由度が高い |

---

## Step#6：外部API（確定）

### 外部サービスAPI

| API | 用途 | 料金 | 実装時期 |
|-----|------|------|----------|
| **Google OAuth 2.0** | ログイン認証 | 無料 | MVP |
| **Stripe** | サブスクリプション決済 | 約3.6% | Phase 11 |
| **PostgreSQL（Neon）** | ユーザー・設定データ永続化 | 無料枠5GB | MVP |

### ブラウザAPI・ライブラリ

| API/ライブラリ | 用途 | 対応ブラウザ | ライセンス |
|----------------|------|--------------|------------|
| **File System Access API** | ローカルファイル読み書き | Chrome/Edge優先 | - |
| **html2pdf.js / jsPDF** | PDF生成 | 全モダンブラウザ | MIT |
| **mammoth.js** | Word→マークダウン変換 | 全モダンブラウザ | MIT |
| **Markmap** | マインドマップ生成 | 全モダンブラウザ | MIT |

### 必要な認証情報

| サービス | 必要な情報 | 管理場所 |
|----------|-----------|----------|
| Google OAuth | Client ID, Client Secret, Redirect URI | Google Cloud Console |
| Stripe | Publishable Key, Secret Key, Webhook Secret | Stripe Dashboard |
| Neon | Connection String | Neon Console |

### API利用時の注意点

| 項目 | 詳細 |
|------|------|
| HTTPS必須 | 全APIでHTTPS接続が必要 |
| CORS設定 | バックエンドでフロントエンドドメイン許可 |
| 環境変数管理 | シークレットは.envで管理、Git除外 |
| テスト環境 | 各APIのテストキー/サンドボックスで事前検証 |

---

## 確定済み要件まとめ

| 項目 | 内容 |
|------|------|
| アプリ形態 | **ブラウザサービス（Webアプリ）** |
| 対応ブラウザ | Chrome / Edge優先（Safari / Firefox制限付き） |
| 利用形態 | 各ユーザーが自分のPCのファイルを編集 |
| ファイル保存先 | ローカルファイルシステム（File System Access API） |
| 同時編集 | 初期バージョンでは実装しない |
| 認証方式 | Googleログインのみ |
| 登録方式 | 自由登録 |
| 商用形態 | サブスクリプション（後日追加） |
| 管理機能 | 利用状況確認、システム設定 |
| 課金プラットフォーム | **Stripe** |

---

## 実装済みフェーズ一覧

### Phase 1: 要件定義 ✅
- **完了日**: 2026-01-26
- 要件定義書作成完了
- ドキュメント: `docs/requirements_draft.md`（本ファイル）

### Phase 2: プロジェクトセットアップ ✅
- Vite + React + TypeScript初期化
- MUI導入
- 基本ディレクトリ構造作成

### Phase 3-10: 機能実装 ✅
- エディタ、プレビュー、ファイル操作、インポート/エクスポート、マインドマップ、お気に入い、管理機能

### Phase 11: サブスクリプション課金（簡易版） ✅
- **完了日**: 2026-02-01
- 認証設定管理（認証方式、パスワードポリシー）
- ユーザー管理画面（一覧、検索、フィルタリング、ステータス変更）
- システム設定UI/UX改善（編集ダイアログ方式）
- ドキュメント: `docs/requirements.md` バージョン 2.1-2.2

### Phase 12: E2Eテスト実装 ✅
- **完了日**: 2026-02-01
- Playwright環境構築完了
- モックOAuthエンドポイント実装
- テストカバレッジ: 95% (38/40テスト合格)
- 解決内容:
  - Chromium依存ライブラリ不足を解決
  - レート制限問題を解決
  - 認証システムを安定化
  - バックエンド接続問題を完全解決

### Phase 13: E2Eテスト100%達成 ✅
- **完了日**: 2026-02-01
- **テストカバレッジ: 100% (40/40テスト合格)** 🎊
- エディタ機能: 13/13テスト合格 ✅
- 管理機能: 19/19テスト合格 ✅
- 認証機能: 9/9テスト合格 ✅
- 実行時間: 10.5分
- ドキュメント: `docs/e2e-specs/` ディレクトリ内の全テスト仕様書

### Phase 14: TypeScriptエラー修正＆CI/CD成功 ✅
- **完了日**: 2026-02-01
- TypeScriptビルドエラー: 11件 → **0件**
- CI/CDワークフロー: All Passed ✅
- Code Quality Workflow: ✅
- E2E Tests Workflow: ✅
- 修正内容:
  - 未使用変数の削除
  - 型インポート修正（verbatimModuleSyntax対応）
  - FileNode型の修正
  - ビルドパイプライン全ステップ成功

### 最新改善（2026-02-03）✅
- RegisterPageの自動入力防止
- HelpDialog・VersionInfoDialogの初期表示修正
- VersionInfoDialogのデザイン統一
- 日本語用語の統一（フォルダ→フォルダー）
- ログイン画面のデモアカウント削除
- AdminLayoutのログアウト機能修正
- 管理画面ヘッダーのメールアドレス表示
- メニューバー詳細仕様の追加
- 差分比較機能詳細仕様の追加
- 設定機能詳細仕様の追加
- CSP（Content Security Policy）セキュリティ強化
- ドキュメント同期（page-design.md バージョン 3.0）

---

## プロジェクト完成度

**100%完成** 🎊

✅ MVP実装完了
✅ E2Eテスト100%達成（ローカル）
✅ CI/CDパイプライン構築完了
✅ TypeScriptビルドエラー 0件
✅ ドキュメント完備（requirements.md バージョン 3.0）
✅ page-design.md バージョン 3.0で全ドキュメント同期
⬜ 本番環境デプロイ（次ステップ）
⬜ Stripe統合（将来の拡張）

---

## 次のステップ

本番環境への展開に向けて：

1. **本番環境デプロイ準備**
   - セキュリティ監査の実施
   - パフォーマンスチューニング
   - ログ・モニタリング設定

2. **保守運用の開始**
   - ユーザーサポート体制の構築
   - バグ報告フローの確立
   - セキュリティアップデート計画

3. **将来の拡張**
   - Phase 15: 本番環境デプロイ
   - Phase 16: Stripe統合（実装版）
   - Phase 17+: ユーザーフィードバック対応

---

## 参考資料

| ドキュメント | 説明 | バージョン |
|------------|------|---------|
| `docs/requirements.md` | 最新要件定義書 | 3.0（2026-02-03） |
| `docs/page-design.md` | ページ詳細設計書 | 3.0（2026-02-03） |
| `docs/SCOPE_PROGRESS.md` | 開発進捗状況 | 最新（2026-02-03） |
| `CLAUDE.md` | AI開発ガイド | 最新 |
