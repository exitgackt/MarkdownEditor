# Phase 1 (P-001) 認証フロー 手動テストチェックリスト

**テスト日**: 2026-01-30
**テスト対象**: 認証フロー（Google OAuth + Email/Password）
**環境**:
- バックエンド: http://localhost:8000
- フロントエンド: http://localhost:5173
- テスター: User + Claude

---

## テスト準備

### 事前確認

- [ ] バックエンド稼働中（http://localhost:8000/health → `{"status":"healthy"}`）
- [ ] フロントエンド稼働中（http://localhost:5173）
- [ ] データベース接続確認
- [ ] メール設定確認（開発環境: ログ出力）
- [ ] Google OAuth Client ID 設定確認

### テストツール

- ブラウザ: Chrome/Edge（開発者ツール使用）
- テスト用メールアドレス: 準備
- 管理者メールアドレス（.env設定）: 確認

---

## セクション 1: 初期状態確認

### 1.1 ログインページ表示

**URL**: http://localhost:5173/login

**確認項目**:
- [ ] ページが正常に表示される
- [ ] 「VS Markdown」ロゴが表示される
- [ ] Google ログインボタンが表示される
- [ ] Email/Password ログインフォームが表示される
  - [ ] メールアドレス入力欄
  - [ ] パスワード入力欄
  - [ ] 「ログイン」ボタン
- [ ] 「アカウント登録」リンクが表示される
- [ ] 「パスワードを忘れた方」リンクが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 1.2 認証設定API確認

**API**: `GET /api/v1/auth/settings`

**ブラウザコンソールで実行**:
```javascript
fetch('http://localhost:8000/api/v1/auth/settings')
  .then(r => r.json())
  .then(d => console.log('Auth Settings:', d))
```

**期待結果**:
```json
{
  "auth_mode": "both" または "email" または "google",
  "google_enabled": true/false,
  "email_enabled": true/false
}
```

**確認項目**:
- [ ] APIレスポンスが返ってくる
- [ ] `auth_mode` が設定されている
- [ ] 設定に応じてUIが表示/非表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 2: Email/Password 認証テスト

### 2.1 ユーザー登録（新規登録）

**URL**: http://localhost:5173/register

#### テストケース 2.1.1: 正常な登録

**手順**:
1. 登録ページにアクセス
2. 以下の情報を入力:
   - 名前: `テストユーザー1`
   - メールアドレス: `test1@example.com`
   - パスワード: `Test1234!`
   - パスワード確認: `Test1234!`
3. 「登録」ボタンをクリック

**期待結果**:
- [ ] 成功メッセージが表示される: 「登録が完了しました。メールに送信された確認リンクをクリックしてください。」
- [ ] バックエンドログに確認メール送信ログが出力される
- [ ] データベースに `email_verified=false` でユーザーが作成される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.2: 既存メールアドレスで登録

**手順**:
1. 上記と同じメールアドレスで再度登録を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「このメールアドレスは既に登録されています」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.3: 弱いパスワード（8文字未満）

**手順**:
1. パスワード: `Test1` （6文字）で登録を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「パスワードは8文字以上である必要があります」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.4: パスワード要件違反（大文字なし）

**手順**:
1. パスワード: `test1234!` （大文字なし）で登録を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「パスワードには大文字を含める必要があります」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.5: パスワード要件違反（小文字なし）

**手順**:
1. パスワード: `TEST1234!` （小文字なし）で登録を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「パスワードには小文字を含める必要があります」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.6: パスワード要件違反（数字なし）

**手順**:
1. パスワード: `TestTest!` （数字なし）で登録を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「パスワードには数字を含める必要があります」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.1.7: フロントエンド - パスワード不一致

**手順**:
1. パスワード: `Test1234!`
2. パスワード確認: `Test1234@` （異なる）
3. 登録を試みる

**期待結果**:
- [ ] フロントエンドでエラーメッセージが表示される
- [ ] APIリクエストが送信されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 2.2 メール検証

#### テストケース 2.2.1: メール検証トークンの確認

**手順**:
1. バックエンドログまたはデータベースから検証トークンを取得
2. 検証URL にアクセス: `http://localhost:5173/verify-email?token={トークン}`

**期待結果**:
- [ ] 「メールアドレスが確認されました」メッセージが表示される
- [ ] データベースで `email_verified=true` に更新される
- [ ] 3秒後に自動的にログインページにリダイレクトされる

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.2.2: 無効なトークンで検証

**手順**:
1. 無効なトークンで検証URL にアクセス: `http://localhost:5173/verify-email?token=invalid-token`

**期待結果**:
- [ ] エラーメッセージが表示される: 「無効な確認トークンです」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.2.3: 検証メール再送信

**手順**:
1. ログインページで「確認メール再送信」をクリック（実装されている場合）
2. 登録したメールアドレスを入力
3. 送信ボタンをクリック

**期待結果**:
- [ ] 「確認メールを再送信しました」メッセージが表示される
- [ ] バックエンドログに新しい確認メール送信ログが出力される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 2.3 Email/Password ログイン

#### テストケース 2.3.1: 正常なログイン

**手順**:
1. ログインページにアクセス
2. 検証済みのメールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

**期待結果**:
- [ ] ログイン成功
- [ ] JWTトークンが localStorage に保存される
- [ ] エディタページ（/editor）にリダイレクトされる
- [ ] ユーザー情報が表示される（右上など）
- [ ] バックエンドで `last_login_at` が更新される
- [ ] ログイン履歴が記録される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.3.2: 無効なメールアドレス

**手順**:
1. 存在しないメールアドレスでログインを試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「メールアドレスまたはパスワードが正しくありません」
- [ ] HTTP 401 エラー
- [ ] ログイン失敗

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.3.3: 無効なパスワード

**手順**:
1. 正しいメールアドレス、間違ったパスワードでログインを試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「メールアドレスまたはパスワードが正しくありません」
- [ ] HTTP 401 エラー
- [ ] ログイン失敗

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.3.4: 未検証メールでログイン

**手順**:
1. 新しいユーザーを登録（検証しない）
2. そのメールアドレスとパスワードでログインを試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「メールアドレスが未確認です。確認メールを確認してください。」
- [ ] HTTP 403 エラー
- [ ] ログイン失敗

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 2.4 パスワードリセット

#### テストケース 2.4.1: パスワードリセット要求

**手順**:
1. ログインページで「パスワードを忘れた方」リンクをクリック
2. 登録済みのメールアドレスを入力
3. 「送信」ボタンをクリック

**期待結果**:
- [ ] 成功メッセージが表示される: 「パスワードリセットメールを送信しました」
- [ ] バックエンドログにリセットメール送信ログが出力される
- [ ] データベースに `password_reset_token` と `password_reset_expires` が保存される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.4.2: 存在しないメールでリセット要求

**手順**:
1. 存在しないメールアドレスでリセットを要求

**期待結果**:
- [ ] 成功メッセージが表示される: 「パスワードリセットメールを送信しました」（セキュリティ: メール存在を漏らさない）
- [ ] 実際にはメールは送信されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.4.3: パスワードリセット実行

**手順**:
1. バックエンドログまたはデータベースからリセットトークンを取得
2. リセットURL にアクセス: `http://localhost:5173/reset-password?token={トークン}`
3. 新しいパスワードを入力: `NewTest1234!`
4. 「リセット」ボタンをクリック

**期待結果**:
- [ ] 成功メッセージが表示される: 「パスワードがリセットされました」
- [ ] データベースで新しいパスワードハッシュが保存される
- [ ] `password_reset_token` と `password_reset_expires` が削除される
- [ ] 新しいパスワードでログイン可能

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.4.4: 無効なトークンでリセット

**手順**:
1. 無効なトークンでリセットURLにアクセス

**期待結果**:
- [ ] エラーメッセージが表示される: 「無効なリセットトークンです」
- [ ] HTTP 400 エラー

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.4.5: 弱い新パスワードでリセット

**手順**:
1. 有効なトークンで新しいパスワードに弱いパスワード（例: `test`）を設定

**期待結果**:
- [ ] エラーメッセージが表示される: パスワード要件エラー
- [ ] HTTP 400 エラー
- [ ] パスワードが更新されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 2.5 パスワード変更（認証済みユーザー）

#### テストケース 2.5.1: 正常なパスワード変更

**手順**:
1. ログイン済みの状態で設定ページまたはプロフィールページにアクセス
2. パスワード変更フォームに入力:
   - 現在のパスワード: `Test1234!`
   - 新しいパスワード: `NewTest5678!`
   - 新しいパスワード確認: `NewTest5678!`
3. 「変更」ボタンをクリック

**期待結果**:
- [ ] 成功メッセージが表示される: 「パスワードが変更されました」
- [ ] データベースで新しいパスワードハッシュが保存される
- [ ] 古いパスワードではログイン不可
- [ ] 新しいパスワードでログイン可能

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 2.5.2: 間違った現在のパスワード

**手順**:
1. 現在のパスワードに間違ったパスワードを入力
2. 変更を試みる

**期待結果**:
- [ ] エラーメッセージが表示される: 「現在のパスワードが正しくありません」
- [ ] HTTP 401 エラー
- [ ] パスワードが変更されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 3: Google OAuth テスト

### 3.1 Google ログイン

#### テストケース 3.1.1: 正常な Google ログイン

**手順**:
1. ログインページで「Google でログイン」ボタンをクリック
2. Google 認証画面でアカウントを選択（または既にログイン済み）
3. 権限を承認

**期待結果**:
- [ ] Google 認証画面が表示される
- [ ] 認証成功後、JWTトークンが localStorage に保存される
- [ ] エディタページ（/editor）にリダイレクトされる
- [ ] ユーザー情報が表示される
- [ ] データベースに `auth_provider='google'` でユーザーが作成される（初回）
- [ ] データベースに `email_verified=true` で作成される
- [ ] ログイン履歴が記録される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 3.1.2: Google ログイン（既存ユーザー）

**手順**:
1. 既に Google ログインしたことがあるアカウントで再度ログイン

**期待結果**:
- [ ] 新しいユーザーは作成されない
- [ ] `last_login_at` が更新される
- [ ] ログイン履歴に新しいレコードが追加される
- [ ] エディタページにリダイレクトされる

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 3.1.3: 管理者メールで Google ログイン

**手順**:
1. `.env` の `ADMIN_EMAILS` に設定されたメールアドレスで Google ログイン

**期待結果**:
- [ ] ログイン成功
- [ ] データベースで `is_admin=true` に設定される
- [ ] 管理画面（/admin）にアクセス可能

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 3.1.4: Google 認証キャンセル

**手順**:
1. Google ログインボタンをクリック
2. 認証画面でキャンセルまたは拒否

**期待結果**:
- [ ] ログインページに戻る
- [ ] エラーメッセージが表示される（実装による）
- [ ] ログイン失敗

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 4: JWT セッション管理

### 4.1 トークン検証

#### テストケース 4.1.1: 有効なトークンで保護ルートアクセス

**手順**:
1. ログイン済みの状態で開発者ツールを開く
2. localStorage から `token` を確認
3. エディタページ（/editor）にアクセス

**期待結果**:
- [ ] トークンが localStorage に保存されている
- [ ] エディタページが正常に表示される
- [ ] API リクエストに `Authorization: Bearer {token}` ヘッダーが付与される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 4.1.2: トークンなしで保護ルートアクセス

**手順**:
1. ログアウトまたは localStorage から token を削除
2. エディタページ（/editor）に直接アクセス

**期待結果**:
- [ ] ログインページ（/login）にリダイレクトされる
- [ ] エディタページは表示されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 4.1.3: 無効なトークンで保護ルートアクセス

**手順**:
1. localStorage の token を改変（例: 最後の文字を変更）
2. エディタページにアクセスまたはページをリロード

**期待結果**:
- [ ] 自動的にログアウトされる
- [ ] ログインページにリダイレクトされる
- [ ] localStorage から token が削除される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 4.2 トークン永続化

#### テストケース 4.2.1: ページリロード後のセッション保持

**手順**:
1. ログイン済みの状態でページをリロード（F5）

**期待結果**:
- [ ] ログイン状態が維持される
- [ ] エディタページが表示される
- [ ] ユーザー情報が表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 4.2.2: ブラウザ再起動後のセッション保持

**手順**:
1. ログイン済みの状態でブラウザを完全に閉じる
2. ブラウザを再起動して http://localhost:5173 にアクセス

**期待結果**:
- [ ] ログイン状態が維持される（localStorage 永続化）
- [ ] エディタページが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 4.3 ログアウト

#### テストケース 4.3.1: 正常なログアウト

**手順**:
1. ログイン済みの状態で「ログアウト」ボタンをクリック

**期待結果**:
- [ ] localStorage から token が削除される
- [ ] Zustand store の認証状態がクリアされる
- [ ] ログインページ（/login）にリダイレクトされる
- [ ] エディタページへのアクセスが不可になる

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 5: 保護ルートアクセス制御

### 5.1 一般ユーザー保護ルート

#### テストケース 5.1.1: 認証済みで /editor アクセス

**手順**:
1. ログイン済みの状態で /editor にアクセス

**期待結果**:
- [ ] エディタページが表示される
- [ ] ファイルツリー、エディタ、プレビューが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 5.1.2: 未認証で /editor アクセス

**手順**:
1. ログアウト状態で /editor に直接アクセス

**期待結果**:
- [ ] ログインページ（/login）にリダイレクトされる

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 5.2 管理者保護ルート

#### テストケース 5.2.1: 管理者で /admin アクセス

**手順**:
1. 管理者アカウントでログイン
2. /admin にアクセス

**期待結果**:
- [ ] 管理画面が表示される
- [ ] ユーザー一覧、利用状況、設定などが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 5.2.2: 非管理者で /admin アクセス

**手順**:
1. 一般ユーザーアカウントでログイン
2. /admin に直接アクセス

**期待結果**:
- [ ] 403 エラーページまたはエディタページにリダイレクトされる
- [ ] 管理画面は表示されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 5.3 リダイレクト動作

#### テストケース 5.3.1: 認証済みで /login アクセス

**手順**:
1. ログイン済みの状態で /login にアクセス

**期待結果**:
- [ ] エディタページ（/editor）にリダイレクトされる
- [ ] ログインページは表示されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 6: セキュリティチェック

### 6.1 パスワードセキュリティ

#### テストケース 6.1.1: パスワード平文保存チェック

**手順**:
1. データベースを確認（開発者ツールまたはDBクライアント）
2. `users` テーブルの `hashed_password` カラムを確認

**期待結果**:
- [ ] パスワードがハッシュ化されている（bcrypt）
- [ ] 平文パスワードは保存されていない
- [ ] ハッシュは `$2b$` で始まる

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 6.2 レート制限

#### テストケース 6.2.1: ログイン試行レート制限

**手順**:
1. 間違ったパスワードで連続して6回ログインを試みる

**期待結果**:
- [ ] 5回目まではエラーメッセージが表示される
- [ ] 6回目以降は 429 エラー（Too Many Requests）が返される
- [ ] エラーメッセージ: レート制限に関するメッセージ

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

#### テストケース 6.2.2: 登録レート制限

**手順**:
1. 異なるメールアドレスで連続して4回登録を試みる

**期待結果**:
- [ ] 3回目まで成功
- [ ] 4回目以降は 429 エラー（Too Many Requests）が返される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 6.3 情報漏洩防止

#### テストケース 6.3.1: メール存在確認の防止

**手順**:
1. 存在しないメールアドレスでログイン試行
2. エラーメッセージを確認

**期待結果**:
- [ ] 「メールアドレスまたはパスワードが正しくありません」（メールが存在するか特定できない）
- [ ] 「メールアドレスが存在しません」などの明示的なメッセージは表示されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 7: エラーハンドリング

### 7.1 バックエンドエラー

#### テストケース 7.1.1: バックエンド停止時のエラー

**手順**:
1. バックエンドを停止（`kill` コマンドなど）
2. ログインを試みる

**期待結果**:
- [ ] フロントエンドでエラーメッセージが表示される
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] スタックトレースは表示されない

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 7.2 フロントエンドエラー

#### テストケース 7.2.1: 無効なJSON形式

**手順**:
1. 開発者ツールでネットワークをシミュレートして無効なレスポンスを返す（実装による）

**期待結果**:
- [ ] エラーハンドリングが機能する
- [ ] アプリケーションがクラッシュしない
- [ ] エラーメッセージが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## セクション 8: ユーザビリティ

### 8.1 フォームバリデーション

#### テストケース 8.1.1: フロントエンドのリアルタイムバリデーション

**手順**:
1. 登録フォームでメールアドレス欄に無効なメール（例: `test@`）を入力
2. 他のフィールドに移動

**期待結果**:
- [ ] リアルタイムでエラーメッセージが表示される（実装されている場合）
- [ ] または送信時にエラーメッセージが表示される

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

### 8.2 ローディング表示

#### テストケース 8.2.1: ログイン処理中のローディング

**手順**:
1. ログインボタンをクリック
2. APIレスポンスが返ってくるまでの間を確認

**期待結果**:
- [ ] ローディングインジケーター（スピナーなど）が表示される
- [ ] ボタンが無効化される（二重送信防止）

**結果**: ⬜ PASS / ⬜ FAIL
**備考**:

---

## テスト結果サマリー

### 統計

- **実施日**: _________
- **総テスト数**: 61
- **合格**: ____ / 61
- **不合格**: ____ / 61
- **スキップ**: ____ / 61

### カテゴリ別結果

| カテゴリ | 合格 | 不合格 | 合格率 |
|---------|-----|-------|--------|
| 初期状態確認 | __ / 2 | __ / 2 | __% |
| Email/Password 認証 | __ / 22 | __ / 22 | __% |
| Google OAuth | __ / 4 | __ / 4 | __% |
| JWT セッション管理 | __ / 7 | __ / 7 | __% |
| 保護ルートアクセス | __ / 5 | __ / 5 | __% |
| セキュリティ | __ / 4 | __ / 4 | __% |
| エラーハンドリング | __ / 2 | __ / 2 | __% |
| ユーザビリティ | __ / 2 | __ / 2 | __% |

---

## 発見されたバグ

### Bug #1:

**カテゴリ**:
**重要度**: 高 / 中 / 低
**説明**:

**再現手順**:
1.
2.
3.

**期待される動作**:

**実際の動作**:

**修正案**:

---

## 推奨事項

1.
2.
3.

---

## 次のステップ

- [ ] バグ修正
- [ ] 再テスト
- [ ] 自動テストの実装検討
- [ ] 本番環境デプロイ前の最終確認

---

**テスト完了日**: _________
**テスター署名**: _________
